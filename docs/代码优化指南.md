# 代码优化指南

**更新日期**: 2025-08-21  
**项目**: Mahavatar Narsimha Movie Website

## 已完成的优化 ✅

### 1. 安全增强
- ✅ 创建了 API 认证中间件 (`/lib/api-auth.ts`)
  - 统一的身份验证
  - 速率限制保护
  - 安全头部设置
  - CORS 配置

- ✅ 更新了 API 端点示例 (`/app/api/get-user-credits/route.ts`)
  - 添加速率限制
  - 改进错误处理
  - 中文注释

### 2. SEO 优化
- ✅ 创建了 SEO 工具库 (`/lib/seo-utils.ts`)
  - 统一的元数据生成器
  - 结构化数据生成器
  - 减少代码重复

### 3. TypeScript 问题修复
- ✅ 修复了未使用的导入
  - `/app/[locale]/watch/mahavatar-narsimha-online/page.tsx`

### 4. 路由问题修复
- ✅ 修复了 404 错误
  - 更新中间件配置
  - 修复错误的内部链接

## 如何使用新的工具

### 1. API 认证示例
```typescript
// 在需要保护的 API 路由中使用
import { requireAuth, rateLimit, getClientIp, apiResponse } from '@/lib/api-auth'

export async function POST(req: NextRequest) {
  // 速率限制
  const ip = getClientIp(req)
  if (!rateLimit(`api:${ip}`, 10, 60000)) {
    return apiResponse(null, '请求过于频繁', 429)
  }
  
  // 身份验证
  const session = await requireAuth(req)
  if (session instanceof NextResponse) {
    return session // 返回错误响应
  }
  
  // 你的业务逻辑
  // ...
}
```

### 2. SEO 元数据生成示例
```typescript
// 在页面中使用统一的元数据生成器
import { generateMovieMetadata } from '@/lib/seo-utils'

export async function generateMetadata({ params }) {
  const { locale } = await params
  
  return generateMovieMetadata(
    'Mahavatar Narsimha Full Movie',
    '观看 Mahavatar Narsimha 完整电影...',
    locale,
    `/movie/mahavatar-narsimha`
  )
}
```

### 3. 结构化数据示例
```typescript
// 添加结构化数据到页面
import { generateMovieSchema } from '@/lib/seo-utils'

const structuredData = generateMovieSchema({
  name: 'Mahavatar Narsimha',
  description: '史诗级神话电影...',
  datePublished: '2025-01-01',
  director: 'Director Name',
  actors: ['Actor 1', 'Actor 2'],
  genre: ['Action', 'Drama', 'Mythology'],
  duration: 'PT2H30M',
  aggregateRating: {
    ratingValue: 4.5,
    reviewCount: 1200
  }
})

// 在页面中嵌入
<script
  type="application/ld+json"
  dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
/>
```

## 待优化项目清单 📝

### 高优先级
- [ ] 为所有敏感 API 端点添加认证
- [ ] 实施完整的速率限制策略
- [ ] 添加输入验证和清理
- [ ] 实施 CSRF 保护

### 中优先级
- [ ] 优化图片加载（使用 next/image）
- [ ] 减少 Bundle Size
- [ ] 实施懒加载
- [ ] 添加缓存策略

### 低优先级
- [ ] 添加单元测试
- [ ] 改进日志记录
- [ ] 优化数据库查询
- [ ] 添加监控和分析

## 代码规范 📏

### 1. 文件命名
- 组件: `PascalCase.tsx`
- 工具函数: `kebab-case.ts`
- 常量: `UPPER_SNAKE_CASE.ts`

### 2. 注释规范
```typescript
/**
 * 函数说明
 * @param param 参数说明
 * @returns 返回值说明
 */
function example(param: string): string {
  // 单行注释说明具体逻辑
  return param
}
```

### 3. 错误处理
```typescript
try {
  // 业务逻辑
} catch (error) {
  // 记录错误但不暴露敏感信息
  console.error('操作失败:', error)
  // 返回用户友好的错误信息
  return apiResponse(null, '操作失败，请重试', 500)
}
```

## 性能优化建议 🚀

### 1. 代码分割
```typescript
// 使用动态导入
const Component = dynamic(() => import('./Component'), {
  loading: () => <Loading />,
  ssr: false
})
```

### 2. 图片优化
```typescript
// 使用 Next.js Image 组件
import Image from 'next/image'

<Image
  src="/image.jpg"
  alt="描述"
  width={800}
  height={600}
  loading="lazy"
  placeholder="blur"
/>
```

### 3. 数据预取
```typescript
// 在服务端预取数据
export async function generateStaticParams() {
  // 预生成静态页面
  return [
    { locale: 'en' },
    { locale: 'zh' }
  ]
}
```

## 安全最佳实践 🔒

### 1. 环境变量
- 永不在客户端暴露敏感信息
- 使用 `NEXT_PUBLIC_` 前缀仅用于公开数据
- 定期轮换密钥和令牌

### 2. 输入验证
```typescript
// 验证用户输入
import { z } from 'zod'

const schema = z.object({
  email: z.string().email(),
  password: z.string().min(8)
})

const result = schema.safeParse(input)
if (!result.success) {
  return apiResponse(null, '输入无效', 400)
}
```

### 3. SQL 注入防护
```typescript
// 使用参数化查询
const query = 'SELECT * FROM users WHERE id = $1'
const values = [userId]
// 不要使用字符串拼接
```

## 监控和日志 📊

### 1. 错误跟踪
```typescript
// 集成 Sentry
import * as Sentry from '@sentry/nextjs'

Sentry.captureException(error, {
  tags: {
    section: 'api',
    action: 'user-credits'
  }
})
```

### 2. 性能监控
```typescript
// 使用 Performance API
const startTime = performance.now()
// 执行操作
const endTime = performance.now()
console.log(`操作耗时: ${endTime - startTime}ms`)
```

## 持续改进计划 📈

### 第一阶段（本周）
1. 完成所有 API 端点的安全加固
2. 统一错误处理机制
3. 优化关键页面性能

### 第二阶段（下周）
1. 实施完整的测试策略
2. 优化数据库查询
3. 改进缓存策略

### 第三阶段（月底前）
1. 完成国际化优化
2. 实施 PWA 功能
3. 添加 A/B 测试能力

## 相关资源 📚

- [Next.js 文档](https://nextjs.org/docs)
- [TypeScript 手册](https://www.typescriptlang.org/docs/)
- [Web.dev 性能指南](https://web.dev/performance/)
- [OWASP 安全指南](https://owasp.org/)

---

**注意**: 请定期更新此文档以反映最新的优化状态。
# Mahavatar Narsimha 技术架构文档

## 系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         用户访问层                             │
│                    (Browser / Mobile App)                     │
└──────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│                          CDN层                                │
│                      (Cloudflare CDN)                         │
│              静态资源缓存 / DDoS防护 / SSL证书                   │
└──────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│                        应用服务层                              │
│                    (Vercel / Next.js)                         │
│         SSR/SSG渲染 / API Routes / 中间件处理                  │
└──────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│                        业务逻辑层                              │
│                      (Service Layer)                          │
│          用户服务 / 订单服务 / 积分服务 / 内容服务               │
└──────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│                        数据访问层                              │
│                    (Data Access Layer)                        │
│              ORM映射 / 数据库连接池 / 缓存管理                  │
└──────────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────────┐
│                         数据存储层                             │
│     Supabase (PostgreSQL)  |  Redis Cache  |  Object Storage │
└──────────────────────────────────────────────────────────────┘
```

## 技术栈详解

### 前端技术

#### Next.js 15.2 App Router
```typescript
// app/layout.tsx - 根布局配置
export default function RootLayout({
  children,
  params: { locale }
}: {
  children: React.ReactNode
  params: { locale: string }
}) {
  return (
    <html lang={locale}>
      <body>{children}</body>
    </html>
  )
}
```

**特性使用**:
- Server Components (默认)
- Client Components (交互组件)
- Streaming SSR
- Partial Prerendering
- Route Groups组织
- Parallel Routes并行路由
- Intercepting Routes拦截路由

#### TypeScript配置
```json
// tsconfig.json - 严格模式配置
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

#### Tailwind CSS配置
```javascript
// tailwind.config.ts - 自定义主题配置
module.exports = {
  theme: {
    extend: {
      colors: {
        // 避免使用indigo/blue，使用橙色系
        primary: {
          50: '#fff7ed',
          500: '#f97316',
          900: '#7c2d12',
        }
      }
    }
  }
}
```

### 后端架构

#### API路由结构
```typescript
// app/api/[resource]/route.ts - RESTful API设计
export async function GET(request: Request) {
  // 获取资源
}

export async function POST(request: Request) {
  // 创建资源
}

export async function PUT(request: Request) {
  // 更新资源
}

export async function DELETE(request: Request) {
  // 删除资源
}
```

#### 服务层设计
```typescript
// services/user.ts - 用户服务示例
export class UserService {
  // 获取用户信息
  static async getUserById(userId: string) {
    // 业务逻辑处理
    // 调用数据访问层
    // 返回处理结果
  }
  
  // 更新用户积分
  static async updateUserCredits(userId: string, credits: number) {
    // 事务处理
    // 积分变更记录
    // 通知相关服务
  }
}
```

#### 数据模型层
```typescript
// models/user.ts - 用户模型定义
interface User {
  id: string
  email: string
  name: string
  credits: number
  role: 'user' | 'admin'
  createdAt: Date
  updatedAt: Date
}

// 数据库操作封装
export class UserModel {
  static async findById(id: string): Promise<User | null> {
    // 查询数据库
  }
  
  static async create(data: Partial<User>): Promise<User> {
    // 创建用户
  }
}
```

### 数据库设计

#### 主要数据表

**users表** - 用户信息
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  password_hash VARCHAR(255),
  role VARCHAR(50) DEFAULT 'user',
  credits INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**orders表** - 订单信息
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  amount DECIMAL(10,2),
  status VARCHAR(50),
  stripe_session_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**credits表** - 积分记录
```sql
CREATE TABLE credits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  amount INTEGER,
  type VARCHAR(50),
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**posts表** - 内容管理
```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(255) UNIQUE,
  title VARCHAR(255),
  content TEXT,
  author_id UUID REFERENCES users(id),
  status VARCHAR(50),
  published_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 认证系统

#### NextAuth.js配置
```typescript
// auth/config.ts - 认证配置
export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // 验证用户凭据
        // 返回用户对象或null
      }
    })
  ],
  callbacks: {
    async session({ session, token }) {
      // 自定义session数据
      return session
    },
    async jwt({ token, user }) {
      // JWT token处理
      return token
    }
  }
}
```

### 支付集成

#### Stripe支付流程
```typescript
// app/api/checkout/route.ts - 创建支付会话
export async function POST(request: Request) {
  const { priceId, userId } = await request.json()
  
  // 创建Stripe会话
  const session = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    line_items: [{
      price: priceId,
      quantity: 1,
    }],
    mode: 'payment',
    success_url: `${process.env.NEXT_PUBLIC_URL}/pay-success/{CHECKOUT_SESSION_ID}`,
    cancel_url: `${process.env.NEXT_PUBLIC_URL}/pricing`,
    metadata: { userId }
  })
  
  // 保存订单记录
  await OrderModel.create({
    userId,
    stripeSessionId: session.id,
    status: 'pending'
  })
  
  return Response.json({ url: session.url })
}
```

#### Webhook处理
```typescript
// app/api/stripe-notify/route.ts - 处理支付回调
export async function POST(request: Request) {
  const sig = request.headers.get('stripe-signature')!
  const body = await request.text()
  
  // 验证webhook签名
  const event = stripe.webhooks.constructEvent(body, sig, webhookSecret)
  
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object
    
    // 更新订单状态
    await OrderModel.updateBySessionId(session.id, {
      status: 'completed'
    })
    
    // 添加用户积分
    await UserService.addCredits(session.metadata.userId, 100)
  }
  
  return Response.json({ received: true })
}
```

### 国际化实现

#### 路由配置
```typescript
// i18n/routing.ts - 国际化路由
export const locales = ['en', 'zh'] as const
export const defaultLocale = 'en'

export function getPathname({ locale, pathname }) {
  if (locale === defaultLocale) {
    return pathname
  }
  return `/${locale}${pathname}`
}
```

#### 翻译使用
```typescript
// 组件中使用翻译
import { useTranslations } from 'next-intl'

export function MovieHero() {
  const t = useTranslations('MoviePage')
  
  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description')}</p>
    </div>
  )
}
```

### 性能优化

#### 缓存策略
```typescript
// lib/cache.ts - 缓存实现
class CacheManager {
  private cache = new Map()
  private timers = new Map()
  
  set(key: string, value: any, ttl: number = 3600000) {
    this.cache.set(key, value)
    
    // 设置过期清理
    if (this.timers.has(key)) {
      clearTimeout(this.timers.get(key))
    }
    
    const timer = setTimeout(() => {
      this.cache.delete(key)
      this.timers.delete(key)
    }, ttl)
    
    this.timers.set(key, timer)
  }
  
  get(key: string) {
    return this.cache.get(key)
  }
}
```

#### 图片优化
```typescript
// 使用Next.js Image组件
import Image from 'next/image'

export function MoviePoster() {
  return (
    <Image
      src="/images/mahavatar-hero.jpg"
      alt="Mahavatar Narsimha"
      width={1920}
      height={1080}
      priority
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,..."
    />
  )
}
```

### 安全措施

#### 输入验证
```typescript
// 使用zod进行数据验证
import { z } from 'zod'

const userSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  name: z.string().min(2).max(50)
})

// API中使用验证
export async function POST(request: Request) {
  const body = await request.json()
  
  try {
    const validatedData = userSchema.parse(body)
    // 处理验证后的数据
  } catch (error) {
    return Response.json({ error: 'Invalid input' }, { status: 400 })
  }
}
```

#### CSRF防护
```typescript
// middleware.ts - CSRF token验证
export function middleware(request: NextRequest) {
  if (request.method !== 'GET') {
    const token = request.headers.get('x-csrf-token')
    const sessionToken = request.cookies.get('csrf-token')
    
    if (!token || token !== sessionToken?.value) {
      return Response.json({ error: 'Invalid CSRF token' }, { status: 403 })
    }
  }
}
```

### 监控与日志

#### 错误追踪
```typescript
// 集成Sentry错误监控
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
})
```

#### 性能监控
```typescript
// 自定义性能追踪
export function trackPerformance(name: string, fn: Function) {
  const start = performance.now()
  const result = fn()
  const duration = performance.now() - start
  
  // 发送到分析服务
  analytics.track('performance', {
    name,
    duration,
    timestamp: new Date().toISOString()
  })
  
  return result
}
```

## 部署架构

### 生产环境配置
```yaml
# vercel.json - Vercel部署配置
{
  "functions": {
    "app/api/*": {
      "maxDuration": 30
    }
  },
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/"
    }
  ]
}
```

### 环境变量管理
```bash
# 生产环境变量
DATABASE_URL=
NEXTAUTH_URL=
NEXTAUTH_SECRET=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
GOOGLE_ADSENSE_CLIENT_ID=
```

## 开发规范

### 代码规范
- 使用ESLint + Prettier
- 遵循Airbnb JavaScript规范
- 组件命名使用PascalCase
- 函数和变量使用camelCase
- 常量使用UPPER_SNAKE_CASE

### Git工作流
- main分支：生产环境
- develop分支：开发环境
- feature/*：功能开发
- hotfix/*：紧急修复

### 测试策略
- 单元测试：Jest + React Testing Library
- 集成测试：Playwright
- E2E测试：Cypress

---

**文档版本**: v1.0.0  
**更新日期**: 2025-08-18  
**维护者**: 技术架构团队